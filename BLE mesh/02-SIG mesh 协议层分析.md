# SIG MESH 协议层
![[assert/Pasted image 20230217152522.png]]

SIG MESH 由 **模型层，基础模型层， 访问层， 上层传输层， 下层传输层， 网络层， 承载层** 组成。


**mesh数据包格式**
![](file://R:\%E5%AD%A6%E4%B9%A0\04.HX_SIG_MESH_TUTORIAL_FOR_VIP-master\Material%20library\Mesh_packet.svg?sanitize=true?lastModify=1676618801)
mesh数据包实际上是利用低功耗蓝牙收发数据，mesh协议栈就是一个基于BLE的big profile
**最大不分组能给应用层的有效载荷包仅有11字节**。实际一次最大可以发送380字节，但是要分包。


## 承载层

- GATT
	GATT承载的作用是为了 **不支持mesh协议栈的设备 与 mesh网络中的节点** 实现间接通讯；通过Proxy节点的mesh proxy service和广播行为实现两类设备的间接通讯。如下图所示。
![[assert/Pasted image 20230217153658.png]]
- ADV
	ADV承载利用BLE的GAP广播和扫描来传送和接收网络PDU，如下图所示：
	![[assert/Pasted image 20230217153824.png]]


## 网络层
1. 底层传输PDU倍合并并组装成网络PDU，然后再被转送到承载层。
2. 解密并验证在输入接口上收到的信息，并转送到上层传输层。或将输出接口的消息加密并验证，然后送到承载层？。

不管是输入还是输出接口，它们都叫做 **“网络接口”**。(网络接口在承载层与网络层之间？)

-   输入接口
    决定传入的mesh信息派发到网络层还是丢弃掉，也就是说决定将mesh信息转入到网络层还是直接丢弃掉；
    
-   输出接口
    决定传出的mesh信息到承载层还是丢弃掉，同时不管是GATT承载还是ADV承载都要将TTL等于1的所有信息全丢掉；同理，也就是说决定将组装好的网络层信息传送到承载层还是丢弃掉；

**代理**以及**中继**的特性是网络层的一种行为，也就是说代理和中继的功能在这一层得到实现。

## 底层传输层
底层传输层接收上层传输层的PDU，然后将这个PDU发送到对端设备的底层传输层。
上层传输层的加密访问载荷包最大是380字节，如果底层传输层需要传输这么大的数据包，需要分段重组，所以当传输的数据量大于11字节时，就需要进行分段重组。如下图
![[assert/Pasted image 20230217155411.png]]

## 上层传输层
上层传输层的主要职责如下：
1. 从访问层接收访问层在荷包并使用app_key对其进行加密和验证，然后将这些信息发送到对端设备的上层传输层；对端设备会使用一样的app_key去验证接收到的信息的合法性。
2. 内部生成的上层传输层的控制消息，同样将这个消息传输到对端设备的上层传输层；**控制消息只在网络层被加密和验证**。

控制消息包含了一些低功耗节点与友好节点之间交流的消息以及心跳消息。

**友好特性与低功耗特性在上层传输层实现。**


## 访问层
访问层负责定义应用如何利用上层传输层，包括：
- 定义应用数据的格式
- 定义并控制在上层传输层执行的加密和解密过程
- 在将数据上传到更高的层之前，对来自上层传输层的数据进行验证，判断是否适合该网络和应用。

## 基础模型层
该层定义了访问层状态，信息以及配置和管理网状网络所需要的模型，配置和管理网状网络所需要的模型主要是以下4个。
1. Configuration Server model
2. Configuration Client model
3. Health Server model
4. Health Client model

## 模型层
模型层涉及模型的实施，包括模型规格中定义的行为、消息、状态、状态绑定等的实现。

