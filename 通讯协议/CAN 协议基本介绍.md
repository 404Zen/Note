# CAN协议简介
CAN(Controller Area Network) 控制器局域网络，是一种能够实现分布式实时控制的串行通信网络。CAN 通过 ISO11898 以及 ISO11519 进行了标准化，是汽车网络的标准协议。

CAN 根据两根线上的电位差来判断总线电平。总线电平分为显性电平与隐性电平，二者必居其一。发送方通过使总线电平发生变换，将消息发送给接收方。

CAN 协议具有以下特点：
- **多主控制**
	在总线空闲时，所有单元都可以发送消息(多主控制)，而两个以上的单元同时开始发送消息时，根据标识符(ID)决定优先级。ID 并不是表示发送的目的地址，而是表示访问总线的消息的优先级，两个以上的单元同时开始发送消息时，对各消息ID的每位进行逐个仲裁。仲裁获胜(被判定为最高优先级)的单元可以继续发送消息，仲裁失败的单元则立刻停止发送消息而进行接收工作。

- **系统的柔软性**
	与总线相连的单元没有类似于“地址”的信息。因此在总线上增加单元时，连接在总线上的其他单元的硬件以及应用层都不需要改变。

- **通信速度快，通信距离远**
	速率最高可达1Mbps(距离小于40M)，距离最远可达10KM(速率低于5Kbps)。

- **具有错误检测、错误通知和错误恢复功能**
	所有单元都可以检测错误(错误检测功能)， 检测出错误的单元会立即通知其他所有单元(错误通知功能)，正在发送消息的单元一旦检测出错误，会强制结束当前的发送。强制结束发送的单元会不断反复地重新发送此消息直到发送成功为止(错误恢复功能)。

- **故障封闭功能**
	CAN 可以判断出错的类型是总线上暂时的数据错误(如外部噪声等)，还是持续的数据错误(如单元内部故障、驱动器故障、短线等等)。由此功能，当总线上发生持续数据错误时，可将引起此故障的单元从总线上隔离出去。
- **连接节点多**
	CAN 总线可以同时连接多个单元的总线，可连接的单元总数理论上是没有限制的。但实际上可连接的单元数量受总线上的时间延迟以及电气负载的限制。降低通信速率，可连接的单元数量增加；提高通信速率，可连接的单元数量减少。

因为以上的特点，CAN 特别适合工业过程监控设备的互连，因此，越来越受到工业界的重视，并已公认为最有前途的现场总线之一。

CAN 协议经过 ISO 标准化之后有两个标准：
- ISO11898 : 针对通信速率为 125Kbps~1Mbps 的高速通信标准。
- ISO11519-2 : 针对通信速率为 125Kbps 以下的低速通信标准。


## 物理特征

**ISO11898 物理层特性**
![](assert/Pasted%20image%2020230409152600.png)
1. 显性电平对应逻辑 0，CAN_H 与 CAN_L 相差 2.5V 左右。
2. 隐性电平对应逻辑 1 , CAN_H 与 CAN_L 相差 0V。
3. 在总线上，显性电平(逻辑0)具有优先权，只要有一个单元输出显性电平，总线上即为显性电平。
4. 隐性电平则具有包容的意味，只有所有的单元都输出隐性电平，总线上才为隐性电平。
5. CAN 总线的起止端都具有一个 120Ω 的终端电阻，用来做阻抗匹配，以减少回波反射。

## 通信帧
CAN 是通过以下5种数据帧进行通信的：
| 帧类型 | 帧用途                                         |
| ------ | ---------------------------------------------- |
| 数据帧 | 用于发送单元向接收单元传送数据的帧             |
| 遥控帧 | 用于接收单元向具有相同ID的发送单元请求数据的帧 |
| 错误帧 | 用于当检测出错误时向其他单元通知错误的帧       |
| 过载帧 | 用于接收单元通知其尚未做好接收准备的帧         |
| 间隔帧 | 用于将数据帧以及遥控帧与前面的帧分开来的帧     | 
其中，数据帧和遥控帧具有标准格式和扩展格式两种。标准格式有 11 个位的标识符(ID)；扩展格式具有 29 个位的 ID。

### 数据帧解析
数据帧一般由 7 个段构成，如下
1. 帧起始。表示数据帧开始的段。
2. 仲裁段。表示该帧优先级的段。
3. 控制段。表示数据的字节数以及保留位的段。
4. 数据段。数据的内容，一帧可以发送0~8字节的数据。
5. CRC段。检查帧的传输错误的段。
6. ACK段。表示确认正常接收的段。
7. 帧结束。表示数据帧结束的段。
![](assert/Pasted%20image%2020230409154246.png)
上图中，D(Dominance)表示显性电平(逻辑0)，R(Recessivity)表示隐性电平。

**帧起始：**
标准帧和扩展帧都是使用 1 个位的显性电平表示帧起始。

**仲裁段：**
表示数据的优先级，标准帧个扩展帧在这一段有所不同，如下图：
![](assert/Pasted%20image%2020230409154551.png)
标准格式的 ID 有 11 位，依次发送 ID28~ID18，禁止高 7 位都为隐性(即基本 ID 不能设置为：0b1111111xxxx)。
扩展格式的 ID 有 29 位，基本 ID 部分为 ID28~ID18，扩展 ID 部分为 ID17~ID0，基本 ID 部分与基本格式一样，禁止高 7 为都设置为隐性(即基本 ID 不能设置为：0b1111111xxxx)。

RTR 位用于标识是否为远程帧(0:数据帧，1:远程帧)；
IDE 位用为标识符选择位，(0:使用标准标识符，1:使用扩展标识符)；
SRR 位为代替远程请求位，为隐性位，他替代了标准帧中的 RTR 位。

**控制段：**
由6个位组成，表示数据段的字节数，标准帧和扩展帧的控制段稍有不同，如下图
![](assert/Pasted%20image%2020230409155605.png)
上图中，r0 与 r1 为保留位，必须全部以显性电平发送，但是接收端可以接收显性、隐性以及任意电平的组合。DLC段为数据长度表示段，高位在前， DLC段有效值为0~8，但是接收方接收到9~15时并不认为是错误。

**数据段：**
数据段可以包含0~8字节的数据。从高位MSB开始输出，标准帧和扩展帧在这个段的定义是一致的。
![](assert/Pasted%20image%2020230409160026.png)

**CRC段：**
该段用于检查帧传输错误。由15个位的CRC顺序和一个CRC界定符(用于分隔)组成。标准帧与扩展帧在这个段也是一样的。
![](assert/Pasted%20image%2020230409160206.png)
CRC 的计算范围为：帧起始，仲裁段，控制段，数据段。接收方以同样的方式计算CRC值并进行比较，不一致时会通报错误。

**ACK段：**
此段用于确认是否正常接收。由 ACK Slot 和 ACK 界定符2个位组成。标准帧和扩展帧在这个段的格式也是相同的。
![](assert/Pasted%20image%2020230409160451.png)
发送单元的 ACK, 发送两个位的隐性位，而接收到正确消息的单元在 ACK Slot 发送显性位，通知发送单元接收结束，这个过程叫做发送ACK/返回ACK。发送 ACK 的是既不处于总线关闭态与休眠态的所有接收单元中，接收到正常消息的单元(发送单元不发送ACK)。所谓的正确消息是指不包含填充错误，格式错误，CRC错误的消息。

**帧结束：**
这个段比较简单，标准帧与扩展帧在这个段格式一样，由7个隐性位组成。

## CAN 的位时序
由发送单元在非同步的情况下发送的每秒钟的位数称之为速率。一个位可以分为4段。
- 同步段(SS)
- 传播时间段(PTS)
- 相位缓冲段1(PBS1)
- 相位缓冲段2(PBS2)

这些段又由可以称为 Time Quantum(以下简称为Tq)的最小时间单位组成。
- 1位可以分为4个段，每个段又由若干个 Tq 组成，这称为时序。

一位由多少个 Tq 组成，每个段又由多少个 Tq 组成等，可以任意设定位时序。通过设定位时序，多个单元可以同时采样，也可以任意设定采样点。各段的作用个Tq数如下表所示。
| 段名称                                           | 段的作用                                                                                                                                                                                                    | Tq 数  |
| ------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------ |
| 同步段(SS:Synchronization Segment)               | 多个连接在总线上的单元通过此段实现时序调整，同步进行接收和发送的工作。由隐性电平到显性电平的边沿或显性电平到隐性电平的边沿最好出现在此段中                                                                  | 1 Tq   |
| 传播时间段(PTS:Propagation Time Segment)         | 用于吸收网络上的物理延迟的段，所谓的物理延迟指的是发送单元的输出延时、总线上的信号传播延时、接收单元的输入延时。这个段的时间位以上各延迟时间之和的2倍                                                       | 1~8 Tq |
| 相位缓冲段1(PBS1:Phase Buffer Segment 1)         | 当信号边沿不能被包含于SS段中时，可以在此段进行补偿。由于各单元以各自独立的时钟工作，细微的时钟误差会累积起来，PBS段用于吸收此误差。通过对相位缓冲段加减SJW吸收误差。SJW加大后允许误差加大，但是通信速率降低 | 1~8Tq  |
| 相位缓冲段2(PBS1:Phase Buffer Segment 2)         | 同 PBS1                                                                                                                                                                                                     | 2~8 Tq |
| 再同步补偿宽度(SJW:reSynchronization Jump Width) | 因时钟频率偏差，传送延时等，各单元由同步误差，SJW为补偿此误差的最大值。                                                                                                                                     | 1~4 Tq |

其中，SS + PTS + PBS1 + PBS2 的 Tq 数之和需为 8~25 Tq。

1个位的构成如下图所示：
![|450](assert/Pasted%20image%2020230409164513.png)
上图中的采样点，指的是读取总线电平，并将读取到的电平作为位值得点。读取位置在PBS1结束处。根据这个位时序，我们就可以计算CAN通信的波特率了。

波特率 = 1/正常的位时间。
正常的位时间 = T<sub>SS</sub> + T<sub>PTS</sub>+T<sub>PBS1</sub>+T<sub>PBS2</sub>
一般的单片机中可以定义 Tq 的时间长度，可以根据 Tq 总数与 Tq 时间长度计算出通信速率。
 

## CAN 仲裁
先看一下 CAN 的仲裁功能是如何实现的。
在总线空闲态，最先开始发送消息的单元获得发送权。
当多个单元同时开始发送时，各发送单元从仲裁段的第一位开始进行仲裁。连续输出显性电平最多的单元可以继续发送，实现过程如下图。
![|580](assert/Pasted%20image%2020230409170417.png)
上图中，单元1与单元2同时开始向总线发送数据，到 T 时刻时，单元1输出隐性电平，而单元2输出显性电平；此时单元1仲裁失利，立刻转入接收状态工作，不再与单元2竞争，而单元2顺利获得总线使用权，进而继续发送消息。**连续发送显性电平多的单元获得总线使用权。**


# STM32F103 的 bxCAN

## 基本介绍
STM32F103 自带的是 bxCAN(Basic Extended CAN)，即基本扩展CAN。他支持 CAN 协议 2.0A 与 2.0B。它的设计目标是，以最小的 CPU 负荷来高效处理大量收到的报文。它也支持报文发送的优先级要求(优先级特性可软件配置)。对于安全紧要的任务，bxCAN 提供所有支持时间触发通信模式所需的硬件功能。

STM32F103 的 bxCAN 的主要特点有：
- 支持 CAN 协议的 2.0A 与 2.0B 主动模式
- 波特率最高达 1Mbps
- 支持时间触发通信
发送
- 具有3个发送邮箱
- 发送报文的优先级特性可软件配置
- 记录发送SOF时刻的时间戳
接收
- 具有3级深度的2个接收FIFO
- 可变的过滤器组(F103最多只有14个)
- 标识符列表
- FIFO溢出处理方式可配置
- 记录接收SOF时刻的时间戳
时间触发通信模式
- 禁止自动重传模式
- 16位自由运行定时器
- 可在最后2个数据字节发送时间戳
管理
- 终端可屏蔽
- 邮箱单独占用1块地址空间，便于提高软件效率

STM32F10x 互联型产品的双 CAN 框图：
![](assert/Pasted%20image%2020230409172735.png)
从图中可以看出两个 CAN 都分别拥有自己的发送邮箱和接收 FIFO，但是他们共用 28 个滤波器。通过 CAN_FMR 寄存器的设置，可以设置滤波器的分配方式。

## 标识符过滤
STM32 的标识符过滤是一个比较复杂的东东，它的存在减少了 CPU 处理 CAN 通信的开销。STM32 的过滤器组最多有 28 个（互联型），但是 STM32F103 只有 14 个（增强型），每个滤波器组 x 由 2 个 32 为寄存器， CAN_FxR1 和 CAN_FxR2 组成。

STM32 每个过滤器组的位宽都可以独立配置，以满足应用程序的不同需求。根据位宽的不同，每个过滤器组可提供：
- 1 个 32 位过滤器，包括： STDID[10:0]、 EXTID[17:0]、 IDE 和 RTR 位
- 2 个 16 位过滤器，包括： STDID[10:0]、 IDE、 RTR 和 EXTID[17:15]位

此外过滤器可配置为，**屏蔽位模式和标识符列表模式**。

**屏蔽位模式**
在**屏蔽位模式**下，标识符寄存器和屏蔽寄存器一起，指定报文标识符的任何一位，应该按照“必须匹配”或“不用关心”处理。

**标识符模式**
而在**标识符列表模式**下，屏蔽寄存器也被当作标识符寄存器用。因此，不是采用一个标识符加一个屏蔽位的方式，而是使用 2 个标识符寄存器。接收报文标识符的每一位都必须跟过滤器标识符相同。

**过滤器组位宽和模式的设置**
(STM32中文参考手册Page.432)
通过 CAN_FMR 的 FBMx 位，可以配置对应的屏蔽/标识符寄存器的标识符列表模式或屏蔽位模式。

为了**过滤出一组标识符**，应设置过滤器组工作在**屏蔽位模式**。
为了**过滤出一个标识符**，应设置过滤器组工作在**标识符列表模式**。
应用程序不用的过滤器组，应该保持在禁用状态。

过滤器组中的每个过滤器，都被编号为(叫做过滤器号)从0开始，到某个最大数值－取决于过滤器组的模式和位宽的设置。

**一个例子(屏蔽位模式)：**
设置过滤组0工作在：1个 32位过滤器-标识符屏蔽模式，然后设置 CAN_F0R1 = 0xFFFF0000, CANF0R2 = 0xFF00FF00。
其中存放到 CAN_F0R1 的值就是期望收到的 ID， 即我们希望收到的映像(STID+EXTID+IDE+RTR)最好是 0xFFFF0000。
而存放到 CAN_F0R2 中的值就是我们必须关心的 ID，表示其收到的映像，其 位[31:24] 和 位[15:8] 这 16 个位必须与 CAN_F0R1 中的一模一样，另外 16 个则不关心，可以一样，也可以不一样，都会认为是正确的 ID，即收到的映像必须是 0xFFxx00xx，才算是正确的。

**过滤器匹配序号：**
一旦收到的报文被存入 FIFO，就可以被应用程序访问。通常情况下，应用程序需要根据报文标识符来辨别不同的数据以进行不同的操作。bxCAN 提供了过滤器匹配序号，以简化这一过程。
根据过滤器优先级规则，过滤器匹配序号和报文一起，被存入邮箱中，因为每个收到的报文，都有与之关联的过滤器匹配序号：
过滤器匹配序号可以通过以下两种方式使用：
- 把过滤器匹配序号跟一系列所期望的值进行比较
- 把过滤器匹配序号当作一个索引来访问目标地址

对于标识符列表模式下的过滤器(非屏蔽方式的过滤器)，软件不需要直接跟标识符进行比较。
对于屏蔽位模式下的过滤器，软件只须对需要的那些屏蔽位(必须匹配的位)进行比较即可。

在给过滤器编号时，并不考虑过滤器组是否为激活状态。另外，每个FIFO各自对其关联的过滤器进行编号。
![](assert/Pasted%20image%2020230409192856.png)

**过滤器优先级规则**
根据过滤器的不同配置，有可能一个报文标识符能通过多个过滤器的过滤；在这种情况下，存放在接收邮箱中的过滤器匹配序号，根据以下优先级规则来确定：
- 位宽为32位的过滤器，优先级高于位宽位16位的过滤器
- 对于位宽相同的过滤器，标识符列表模式的优先级高于屏蔽位模式
- 位宽和模式都相同的过滤器，优先级由过滤器号决定，过滤器号小的优先级高。


## 发送流程
CAN 的发送流程为：
1. 程序选择一个空置的邮箱(TME = 1)
2. 设置标识符(ID)，数据长度和发送数据
3. 设置 CAN_TIxR 的 TXRQ 位为 1，请求发送
4. 邮箱挂号(等待成为最高优先级)
5. 预定发送(等待总线空闲)
6. 发送
7. 邮箱空置
如图所示:
![|800](assert/Pasted%20image%2020230409185743.png)

**发送中断**
一旦邮箱中的报文被成功发送后，它马上变为空置邮箱；硬件相应地对CAN_TSR寄存器的RQCP和TXOK位置1，来表明一次成功发送。如果发送失败，由于仲裁引起的就对CAN_TSR寄存器的ALST位置’1’，由于发送错误引起的就对TERR位置’1’。

**发送优先级**
- 由标识符决定：当有超过1个发送邮箱在挂号时，发送顺序由邮箱中报文的标识符决定。根据CAN协议，**标识符数值最低的报文具有最高的优先级**。如果标识符的值相等，那么邮箱号小的报文先被发送。
- 由发送请求顺序决定：通过对CAN_MCR寄存器的TXFP位置’1’，可以把发送邮箱配置为发送FIFO。在该模式下，发送的优先级由发送请求次序决定。**该模式对分段发送很有用。**

**中止**
通过对CAN_TSR寄存器的ABRQ位置’1’，可以中止发送请求。
邮箱如果处于挂号或预定状态，发送请求马上就被中止了。
如果邮箱处于发送状态，那么中止请求可能导致2种结果。
1. 如果邮箱中的报文被成功发送，那么邮箱变为空置邮箱，并且CAN_TSR寄存器的TXOK位被硬件置’1’。
2. 如果邮箱中的报文发送失败了，那么邮箱变为预定状态，然后发送请求被中止，邮箱变为空置邮箱且TXOK位被硬件清’0’。
因此如果邮箱处于发送状态，那么在发送操作结束后，邮箱都会变为空置邮箱。

**禁止自动重传模式**
该模式主要用于满足CAN标准中，时间触发通信选项的需求。通过对CAN_MCR寄存器的NART位置’1’，来让硬件工作在该模式。
在该模式下，发送操作只会执行一次。如果发送操作失败了，不管是由于仲裁丢失或出错，硬件都不会再自动发送该报文。
在一次发送操作结束后，硬件认为发送请求已经完成，从而对CAN_TSR寄存器的RQCP位置’1’，**同时发送的结果反映在TXOK、 ALST和TERR位上**。

## 时间触发通信模式
在该模式下，CAN 硬件内部的定时器被激活，并且被用于产生(发送与接收邮箱的)时间戳，分布存储在 CAN_RDTxR/CAN_TDTxR 寄存器中。内部定时器在每个 CAN 位时间累加，内部定时器在接收和发送的帧起始位的采样点位置进行采样，并生成时间戳。

## 接收流程
CAN 接收到的有效报文，被存储在 3 级邮箱深度的 FIFO 中。 FIFO 完全由硬件来管理，从而节省了 CPU 的处理负荷，简化了软件并保证了数据的一致性。应用程序只能通过读取 FIFO输出邮箱，来读取 FIFO 中最先收到的报文。这里的有效报文是指那些正确被接收的（直到 EOF都没有错误）且通过了标识符过滤的报文。前面我们知道 CAN 的接收有 2 个 FIFO，我们每个滤波器组都可以设置其关联的 FIFO，通过 CAN_FFA1R 的设置，可以将滤波器组关联到FIFO0/FIFO1。

CAN 的接收流程如下：
1. FIFO 空
2. 收到有效报文
3. 挂号_1(存入FIFO的一个邮箱，硬件控制)
4. 收到有效报文
5. 挂号_2
6. 收到有效报文
7. 挂号_3
8. 收到有效报文
9. 溢出
10. 
这个流程里面，我们没有考虑从 FIFO 读出报文的情况，实际情况是：我们必须在 FIFO 溢出之前，读出至少 1 个报文，否则下个报文到来，将导致 FIFO 溢出，从而出现报文丢失。每读出 1 个报文，相应的挂号就减 1，直到 FIFO 空。

**FIFO溢出处理**
当FIFO处于挂号_3状态(即FIFO的3个邮箱都是满的)，下一个有效的报文就会导致溢出，并且一个报文会丢失。此时，硬件对CAN_RFR寄存器的FOVR位进行置’1’来表明溢出情况。至于哪个报文会被丢弃，取决于对FIFO的设置：
- 如果禁用了 FIFO 锁定功能(CAN_MCR->RFLM = 0)，那么 FIFO 中最后收到的报文就被新的报文所覆盖，这样最新的报文就不会被丢弃。
- 如果启用了 FIFO 锁定功能(CAN_MCR->RFLM = 1)，那么新收到的报文将被丢弃，软件可以读取到 FIFO 最早收到的三个报文。

**接收中断**
一旦往FIFO存入一个报文，硬件就会更新FMP[1:0]位，并且如果CAN_IER寄存器的FMPIE位为’1’，那么就会产生一个中断请求。

当FIFO变 满 时(即 第3个 报 文 被 存 入)， CAN_RFR寄 存 器 的FULL位 就 被 置’1’， 并 且 如 果CAN_IER寄存器的FFIE位为’1’，那么就会产生一个满中断请求。

在溢出的情况下， FOVR位被置’1’，并且如果CAN_IER寄存器的FOVIE位为’1’，那么就会产生一个溢出中断请求。

接收流程如下图所示：
![|800](assert/Pasted%20image%2020230409190251.png)

## 报文存储
邮箱是软件和硬件之间传递报文的接口。邮箱包含了所有跟报文有关的信息：标识符、数据、控制、状态和时间戳信息。

软件需要在一个空的发送邮箱中，把待发送报文的各自信息设置好，然后再发出发送请求。发送的状态可以通过查询 CAN_TSR 寄存器获知。

**接收邮箱**
在接收到一个报文后，软件就可以访问接收 FIFO 的输出邮箱来读取它。一旦软件处理了报文(如读取报文)，软件就应该把 CAN_RFxR->RFOM 位置 1，来释放该报文，以方便为后面接收报文流出存储空间。过滤器匹配序号存放在 CAN_RDTxR->FMI 中。 16 位的时间戳存放在 CAN_RDTxR->TIME[15:0]中。

## 出错管理
CAN 协议描述的出错管理，完全由硬件通过发送错误计数器(CAN_ESR->TEC)和接收错误计数器(CAN_ESR->REC)来实现。其值根据错误的情况而增加或者减少。关于 TEC 和 REC 管理的详细信息，请参考 CAN 标准。

软件可以读出它们的值来判断 CAN 网络的稳定性。

此外，CAN_ESR 寄存器提供了当前错误状态的详细信息。通过设置 CAN_IER 寄存器(比如 EERIE 位)，当检测到中断时软件可以灵活地控制中断地产生。

**离线恢复**
当 TEC 大于 255 时，bxCAN 就进入离线状态，同时 CAN_ESR 寄存器的 BOFF 位被置“1”，在离线状态下，bxCAN 无法接收和发送报文。

根据 CAN_MCR->ABOM 的设置，bxCAN 可以自动或者在软件的请求下，从离线状态恢复(变为错误主动状态)。在这两种情况下，bxCAN 都必须等待一个 CAN 标准所描述的恢复过程(CAN RX 引脚上检测到 128 次 11 个连续的隐性位)。

如果 ABOM = 1，bxCAN 进入离线状态后，就自动开启恢复过程。
如果 ABOM = 0，软件必须先请求 bxCAN 进入然后再退出初始化模式，随后恢复过程才被开启。_(??? 此处需要对比英文原版)_

_注意：在初始化模式下，bxCAN 不会监视 CAN RX 引脚的状态，这样就不能完成恢复过程。**为了完成恢复过程，bxCAN必须工作在正常模式。**_
![](assert/Pasted%20image%2020230409210629.png)

## 位时间特性
通过位时间特性逻辑来采样与监视串行 CAN 总线的行为，并通过帧起始位的边沿进行同步，及通过与后面的边沿进行重新同步，来调整其采样点。

如上所述，将名义上的每位时间分为以下三段：
- 同步段(SYNC_SEG) ：通常期望位的变化发生在该时间段内，其值固定为 1 个时间单元(1 x t<sub>CAN</sub>)
- 时间段1(BS1) : 定义采样点的位置。这一段包含了 CAN 标准中的 PROP_SEG 和 PHASE_SEG1。其值可以编程为 1~16 个时间单元，但也可以被自动延长，以补偿因为网络中不同节点的频率差异所造成的相位正向漂移。
- 时间段2(BS2) ：定义发送点的位置。它代表 CAN 标准中的 PHASE_SEG2。其值可编程为 1~8 个时间单元，但也可以被自动缩短以补偿相位的负向漂移。
重新同步跳跃宽度(SJW)定义了，在每位中可以延长或缩短多少个时间单元的上限。其值可编程为 1~4 个时间单元。

有效跳变被定义为，当 bxCAN 自己没有发送隐性位时，从显性位到隐性位的第一次转变。

如果在时间段1(BS1)而不是在同步段(SYNC_SEG)检测到有效跳变，那么 BS1 的时间就被延长为最多 SJW 那么长，从而采样点被延迟了。

相反如果在时间段2(BS2)而不是在 SYNC_SEG 段检测到有效跳变，那么 BS2 的时间就会变缩短最多 SJW 那么长，从而采样点被提前了。

为了避免软件的编程错误，对为时间特性寄存器(CAN_BTR)的设置，只能在 bxCAN 处于初始化状态下进行。

_注：关于 CAN 位时间特性和重同步机制的详细信息，请参考 ISO11898 标准。_
![](assert/Pasted%20image%2020230409212056.png)
![](assert/Pasted%20image%2020230409212143.png)